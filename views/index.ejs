<head>
    <meta name="xm-bind-id-client_id" content="<%= process.env.CLIENT_ID %>">
    <!--meta http-equiv="Content-Security-Policy" content="default-src https://loginapp-lmartinezj.herokuapp.com/; script-src 'unsafe-inline'; child-src 'none'; object-src 'none'"-->

</head>

<body>
    
    <h1>Auth Code: <%= authCode %> </h1>
    <form method="post" action="/token">
        <input type="hidden" name="authCode" value="<%= authCode %>">
        <button type="submit" name="token">Request Token</button>
    </form>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=Promise%2CPromise.prototype.finally%2CTextDecoder%2CTextEncoder%2CObject.entries"></script>
    <script src="https://signin.bindid-sandbox.io/bindid-sdk/transmit-bind-id-sdk.js" defer></script>
    <!--script src="/javascripts/bind-id.js" defer></script-->
    <script async="true">
        function sendAuthCodeToServer(authCode) {
            // Add code to send the authCode to your application server here
            fetch('/token', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'    
                },
                body: JSON.stringify({ code: authCode })
            })
            .then(res => {
                return res.json()
            })
            .then(data =>  { 
                console.log('data: ' + data)
                return data
            })
            .catch(err => handleError(err))
        }

        function handleError(err) {
            // Add code to process the authentication error here
            console.log('ERROR: ' + err)
        
        }
        async function retryProcessRedirectResponse(nthTry) {
            try {
                const isInitialized = await self.XmBindId.initialize('<%= process.env.CLIENT_ID %>')
                if (isInitialized) {
                    console.log('Initialized')
                    const res = await self.XmBindId.processRedirectResponse()
                    const data = await sendAuthCodeToServer(res.code);
                }
                console.log(data)
                return data
            } catch (err) {
                if (nthTry === 1) { 
                    handleError(err); 
                    return
                }
                console.log('retrying processRedirectResponse()', nthTry, 'time');
                
                return retryProcessRedirectResponse(nthTry - 1)
            }
        }
        var myXmBindId = window.XmBindId
        while (myXmBindId == undefined) {
            console.log(JSON.stringify(window.XmBindId))
        }
        console.log(JSON.stringify(window.XmBindId))
        

    </script>

    
    <!--script async="true">
        /*
        function sendAuthCodeToServer(authCode) {

            
            var requestOptions = {
            method: 'POST',
            headers: myHeaders, //aqui voy
            body: urlencoded,
            redirect: 'follow',
            mode: 'no-cors'
            };
            

            fetch("/token", requestOptions)
            .then(response => response.text())
            .then(result => console.log(result))
            .catch(error => console.log('error', error));
            

            
        }
        */

        /*
        function handleError(err) {
         // Add code to process the authentication error here
         console.log('error:' + err)
        }
        
        window.XmBindId.processRedirectResponse()
        .then(
             res => { 
                res => JSON.stringify(res)
            },
            err => handleError(err))
        .then(
            data => {
                sendAuthCodeToServer(JSON.parse(data).code)
            },
            err => handleError(err)
        )
        */     
    </script-->

</body>